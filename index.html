<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Page Title</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

    </head>
    <body>
        <button type="button" class="btn btn-primary" onclick="CheckRecentMatchUp(krtkoId);">Krtko</button>
        <button type="button" class="btn btn-primary" onclick="CheckRecentMatchUp(walrusId);">Walrus</button>
        <button type="button" class="btn btn-primary" onclick="CheckRecentMatchUp(goblinGooId);">Goblingoo</button>
        <input type="text" id="custom-id-input">
        <button type="button" class="btn btn-primary" onclick="CheckCustomId();">CustomId</button>
        <div id="win-results">
        </div>

    </body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <script>

        const winResultsDiv = document.querySelector("#win-results");
        const customIdInput = document.querySelector("#custom-id-input");
        const krtkoId = 5414457;
        const walrusId = 7287677;
        const goblinGooId = 7546983;

        class MatchUpResults {
            constructor(mainPlayerId, opponentPlayerId, opponentName, games) {
                this.mainPlayerId = mainPlayerId;
                this.opponentPlayerId = opponentPlayerId;
                this.opponentName = opponentName;
                this.games = games;
            }
        }
        class Game {
            constructor(id, didWin, startedAt) {
                this.id = id;
                this.didWin = didWin;
                this.startedAt = startedAt;
            }
        }

        async function GetJsonOfRecentGames(playerId, limit) {
            const apiUrl = `https://aoe4world.com/api/v0/players/${playerId}/games?limit=${limit}`;
            const results = await fetch(apiUrl);
            return await results.json();
        }
        async function GetJsonForMatchedGames(mainPlayerId, opponentPlayerId) {
            const apiUrl = `https://aoe4world.com/api/v0/players/${mainPlayerId}/games?opponent_profile_id=${opponentPlayerId}`;
            const results = await fetch(apiUrl);
            return await results.json();
        }
        async function GetMatchUpResults(mainPlayerId, opponentPlayerId) {
            const results = await GetJsonForMatchedGames(mainPlayerId, opponentPlayerId);
            const games = [];
            let opponentName = "NotFound";
            for (let i = 0; i < results.games.length; i++) {
                const game = results.games[i];
                const teams = game.teams;
                let didWin = false;
                for (let teamIndex = 0; teamIndex < teams.length; teamIndex++) {
                    const innerTeam = teams[teamIndex];
                    for (let innerTeamIndex = 0; innerTeamIndex < innerTeam.length; innerTeamIndex++) {
                        const member = innerTeam[innerTeamIndex].player;
                        if (member.profile_id === mainPlayerId) {
                            didWin = member.result === "win";
                        }
                        if (member.profile_id === opponentPlayerId) {
                            opponentName = member.name;
                        }
                    }
                }
                games.push(new Game(game.game_id, didWin, Date.parse(game.started_at)));
            }

            return new MatchUpResults(mainPlayerId, opponentPlayerId, opponentName, games);
        }
        async function GetRecentMatchUps(playerId) {
            const results = await GetJsonOfRecentGames(playerId, 3);
            const matchUpResults = [];
            for (let i = 0; i < results.games.length; i++) {
                const gameJson = results.games[i];
                let enemyTeam = null;
                const teams = gameJson.teams;
                for (let teamIndex = 0; teamIndex < teams.length; teamIndex++) {
                    const team = teams[teamIndex];
                    let foundMe = false;
                    for (let innerTeamIndex = 0; innerTeamIndex < team.length; innerTeamIndex++) {
                        const player = team[innerTeamIndex].player;
                        if (player.profile_id === playerId) {
                            foundMe = true;
                            break;
                        }
                    }

                    if (foundMe === false) {
                        enemyTeam = team;
                    }
                }
                for (let enemyTeamIndex = 0; enemyTeamIndex < enemyTeam.length; enemyTeamIndex++) {
                    const enemyPlayer = enemyTeam[enemyTeamIndex].player;
                    const matchUp = await GetMatchUpResults(playerId, enemyPlayer.profile_id);
                    matchUpResults.push(matchUp);
                }

            }

            return matchUpResults;
        }



        async function CheckRecentMatchUp(playerId) {
            const matchUpResults = await GetRecentMatchUps(playerId);

            let htmlResults = "";

            for (let i = 0; i < matchUpResults.length; i++) {
                const matchUp = matchUpResults[i];
                htmlResults += `Games against ${matchUp.opponentName}:<br>`;
                for (let gameIndex = 0; gameIndex < matchUp.games.length; gameIndex++) {
                    const game = matchUp.games[gameIndex];
                    htmlResults += `Game - didWin ${game.didWin} - ${game.startedAt}<br>`;
                    htmlResults += `<a target="_blank" href="https://aoe4world.com/players/${matchUp.mainPlayerId}/games/${game.id}">Game data</a><br>`;
                }
                htmlResults += "<br><br><br>";
            }

            winResultsDiv.innerHTML = htmlResults;
        }

        async function CheckCustomId() {
            CheckRecentMatchUp(parseInt(customIdInput.value));
        }
    </script>
</html>
